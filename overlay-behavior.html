<link rel="import" href="../polymer/polymer.html">

<script>
(function() {
  'use strict';

  window.OverlayBehavior = {

    hostAttributes: {
      'tabindex': '-1'
    },

    properties: {

      opened: {
        type: Boolean,
        value: false,
        notify: true,
        observer: '__openedChanged'
      },

      hostTarget: Object,

      noCancelOnEscKey: {
        type: Boolean,
        value: false
      },

      noCancelOnPopState: {
        type: Boolean,
        value: false
      },

      cancelOnOutsideClick: {
        type: Boolean,
        value: false
      },

      onDetach: {
        type: Function
      },

      canceled: {
        type: Boolean,
        readOnly: true,
        value: false
      },

      noAutoFocus: {
        type: Boolean,
        value: false
      }

    },

    get __hostTarget() {
      return this.hostTarget || document.body;
    },

    created: function() {
      this.__onKeydown = this.__onKeydown.bind(this);
      this.__onDocumentMousedown = this.__onDocumentMousedown.bind(this);

      this.fire('overlay-created', {
        overlay: this
      }, {
        node: document.body
      });
    },

    attached: function() {
      this.__toggleListeners(true);
      this.style.outline = 0;
    },

    detached: function() {
      this.fire('overlay-detached', {
        overlay: this
      }, {
        node: this.isAttached ? this : this.__hostTarget
      });

      if (typeof this.onDetach === 'function') {
        this.onDetach();
      }

      this.__toggleListeners(false);
    },

    __toggleListeners: function(enable) {
      var m = (enable ? 'add' : 'remove') + 'EventListener';

      this[m]('keydown', this.__onKeydown);
      document[m]('mousedown', this.__onDocumentMousedown);
    },

    /**
     * Fired when the opened property changes.
     *
     * @param {!Boolean} opened
     * @param {Boolean} old
     */
    __openedChanged: function(opened, old) {
      if (opened) {
        // Attach or reattach this element if needed
        if (!this.isAttached || this.hostTarget) {
          if (this.parentElement !== this.__hostTarget) {
            Polymer.dom(this.__hostTarget).appendChild(this);
          }
        }

        this._setCanceled(false);
        this.style.display = '';
        if (!this.noAutoFocus) {
          this.focus();
        }

        this.fire('overlay-opened', {overlay: this});
      } else if (old) {
        this.style.display = 'none';

        this.fire('overlay-closed');
      } else {
        this.style.display = 'none';
      }
    },

    __onKeydown: function(event) {
      var escKey = 27;

      if (!this.noCancelOnEscKey && event.keyCode === escKey) {
        this._setCanceled(true);
        this.opened = false;
      }
    },

    __onDocumentMousedown: function(event) {
      if (!this.cancelOnOutsideClick) {
        return;
      }

      var path = Polymer.dom(event).path;
      var permitted;
      for (var i = 0; i < path.length; i++) {
        if (path[i] === this) {
          permitted = true;
          break;
        }
      }

      if (!permitted) {
        this.opened = false;
      }
    }

  };

})();
</script>
