<link rel="import" href="../polymer/polymer.html">

<script>
(function() {
  'use strict';

  window.OverlayBehavior = {
    
    hostAttributes: {
      'tabindex': '-1'
    },

    properties: {

      opened: {
        type: Boolean,
        value: false,
        notify: true,
        observer: '__openedChanged'
      },

      hostTarget: Object,

      noCancelOnEscKey: {
        type: Boolean,
        value: false
      },
      
      noCloseOnPopState: {
        type: Boolean,
        value: false
      },

      onDetach: {
        type: Function
      },
  
      canceled: {
        type: Boolean,
        readOnly: true,
        value: false
      }

    },

    get __hostTarget() {
      return this.hostTarget || document.body; 
    },

    created() {
      this.__onKeydown = this.__onKeydown.bind(this);
      
      this.fire('overlay-created', {
        overlay: this
      }, {
        node: document.body
      });
    },

    attached() {
      this.__toggleListeners(true);
      this.style.outline = 0;
    },

    detached() {
      this.fire('overlay-detached', {
        overlay: this
      }, {
        node: this.isAttached ? this : this.__hostTarget
      });

      if (typeof this.onDetach === 'function') {
        this.onDetach();
      }

      this.__toggleListeners(false);
    },

    __toggleListeners(enable) {
      const m = (enable ? 'add' : 'remove') + 'EventListener';

      this[m]('keydown', this.__onKeydown);
    },

    /**
     * Fired when the opened property changes.
     *
     * @param {!Boolean} opened
     * @param {Boolean} old
     */
    __openedChanged(opened, old) {
      if (opened) {
        // Attach or reattach this element if needed
        if (!this.isAttached || this.hostTarget) {
          if (this.parentElement !== this.__hostTarget) {
            Polymer.dom(this.__hostTarget).appendChild(this);
          }
        }

        this._setCanceled(false);
        this.style.display = '';
        this.focus();

        this.fire('overlay-opened', {overlay: this});
      } else if (old) {
        this.style.display = 'none';

        const event = this.fire('overlay-closed');
      } else {
        this.style.display = 'none';
      }
    },

    __onKeydown(event) {
      const escKey = 27;

      if (!this.noCancelOnEscKey && event.keyCode === escKey) {
        this._setCanceled(true);
        this.opened = false;
      }
    }

  };

})();
</script>
