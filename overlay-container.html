
<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="overlay-container">
  <template>
    <style>
      #overlays {
        pointer-events: all;
      }
    </style>

    <div id="overlays"></div>

  </template>

  <script>

    class OverlayContainer extends Polymer.Element {

      static get is() {return 'overlay-container';}

      get overlays() {
        return this.$.overlays.children;
      }

      get currentOverlay() {
        const overlays = this.overlays;
        let currentOverlay;
        for (let i = overlays.length - 1; i >= 0; i--) {
          if (overlays[i].opened) {
            currentOverlay = overlays[i];
            break;
          }
        }
        return currentOverlay;
      }

      ready() {
        super.ready();
        document.body.addEventListener('overlay-created', this.__onOverlayCreated.bind(this));
        this.addEventListener('overlay-opened', this.__onOverlayOpened.bind(this));
        this.addEventListener('overlay-closed', this.__onOverlayClosed.bind(this));
        window.addEventListener('popstate', this.__onPopstate.bind(this));
      }

      __onOverlayCreated(event) {
        const overlay = event.detail.overlay;
        overlay.hostTarget = this.$.overlays;
      }

      __onOverlayClosed(event) {
        const currentOverlay = this.currentOverlay;
        // Focus next opened overlay
        if (this.currentOverlay) {
          this.currentOverlay.focus();
        }
      }

      __onOverlayOpened(event) {
        const overlay = event.detail.overlay;
        if (!overlay.noCancelOnPopState) {
          history.pushState({}, '', location.href);
        }
        if (overlay.unique) {
          const overlays = this.overlays;
          for (let i = overlays.length - 1; i >= 0; i--) {
            if (overlays[i] !== overlay && overlays[i].localName === overlay.localName
                && overlays[i].opened) {
              overlays[i].opened = false;
              break;
            }
          }
        }
      }

      __onPopstate() {
        const currentOverlay = this.currentOverlay;
        if (currentOverlay && !currentOverlay.noCancelOnPopState) {
          currentOverlay._setCanceled(true);
          currentOverlay.opened = false;
        }
      }

    }

    customElements.define(OverlayContainer.is, OverlayContainer);

  </script>
</dom-module>