<link rel="import" href="../polymer/polymer.html">

<dom-module id="overlay-container">
  <template>
    <style>
      #overlays {
        pointer-events: all;
      }    
    </style>    
    <div id="overlays"></div>
  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'overlay-container',

    properties: {
    },

    get overlays() {
      return Array.from(this.$.overlays.children);
    },

    get currentOverlay() {
      const overlays = this.overlays;
      let currentOverlay;

      for (let i = overlays.length - 1; i >= 0; i--) {
        if (overlays[i].opened) {
          currentOverlay = overlays[i];
          break;
        }
      }

      return currentOverlay;
    },

    ready() {
      this.listen(document.body, 'overlay-created', '_onOverlayCreated');
      this.listen(this, 'overlay-opened', '_onOverlayOpened');
      this.listen(this, 'overlay-closed', '_onOverlayClosed');
      this.listen(window, 'popstate', '_onPopstate');
    },

    _onOverlayCreated(event) {
      const overlay = event.detail.overlay;
      overlay.hostTarget = this.$.overlays;
    },

    _onOverlayClosed(event) {
      const currentOverlay = this.currentOverlay;

      // Focus next opened overlay
      if (this.currentOverlay) {
        this.currentOverlay.focus();
      }
    },

    _onOverlayOpened(event) {
      if (!event.detail.overlay.noCancelOnPopState) {
        history.pushState({}, '', location.href);
      }
    },

    _onPopstate() {
      const currentOverlay = this.currentOverlay;

      if (currentOverlay && !currentOverlay.noCancelOnPopState) {
        currentOverlay._setCanceled(true);
        currentOverlay.opened = false;
      }
    }

  });

}());
</script>
