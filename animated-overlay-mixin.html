<link rel="import" href="overlay-mixin.html">

<script>

  window.AnimatedOverlayMixin = subclass => class extends OverlayMixin(subclass) {

    static get config() {
      return {
        properties: {

          openAnimationConfig: {
            type: Object,
            value: _ => {
              return {
                keyframes: [
                  {opacity: 0, transform: 'translateY(100px)'}, 
                  {opacity: 1, transform: 'translateY(0)'}               
                ],
                options: {
                  duration: 225,
                  easing: 'cubic-bezier(0.165, 0.84, 0.44, 1)'
                }
              };
            } 
          },

          closeAnimationConfig: {
            type: Object,
            value: _ => {
              return {
                keyframes: [
                  {opacity: 1, transform: 'translateY(0)'},     
                  {opacity: 0, transform: 'translateY(100px)'}             
                ],
                options: {
                  duration: 300,
                  easing: 'cubic-bezier(0.645, 0.045, 0.355, 1)',
                  fill: 'forwards'
                }
              };
            }
          }

        }

      };
    }

    constructor() {
      super();

      this.addEventListener('overlay-opened', this.__animateIn.bind(this));
      this.addEventListener('overlay-closed', this.__animateOut.bind(this));
    }

    __animateIn() {
      this.__beforeAnimate();
      
      requestAnimationFrame(_ => {
        const config = this.openAnimationConfig;

        this.__animation = this.animate(config.keyframes, config.options);
        this.__animation.onfinish = _ => {
          this.__afterAnimate();
          this.focus();

          this.dispatchEvent(new CustomEvent('finish-open-overlay-open-animation', {
            bubbles: true,
            composed: true
          }));
        };
      });
    }

    __animateOut() {
      this.style.display = '';
      this.__beforeAnimate();

      requestAnimationFrame(_ => {
        const config = this.closeAnimationConfig;

        this.__animation = this.animate(config.keyframes, config.options);
        this.__animation.onfinish = _ => {
          this.__afterAnimate();
          this.remove();

          this.dispatchEvent(new CustomEvent('finish-close-overlay-animation', {
            bubbles: true,
            composed: true
          }));
        };
      });
    }

    __beforeAnimate() {
      document.body.style.overflow = 'hidden';
      this.style.willChange = 'transform';
    }

    __afterAnimate() {
      document.body.style.overflow = '';
      this.style.willChange = '';
      this.__animation = null;
    }
  };

</script>
